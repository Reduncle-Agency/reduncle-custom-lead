{% comment %}
  Secci√≥n para crear p√°gina personalizada de cliente con IA
  Env√≠a datos y prompt al servidor de Render
{% endcomment %}

{% if customer and customer.tags contains 'due√±o' %}
  <section class="page-width" style="padding: 40px 20px;">
    <h2>{{ section.settings.title }}</h2>
    
    <form id="create-client-form" style="max-width: 800px; margin: 30px auto;">
      <div style="margin-bottom: 30px;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 18px;">üñºÔ∏è Logo (opcional):</label>
        {% if section.settings.logo %}
          <div style="margin-bottom: 15px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-weight: 600; color: #333;">Logo desde Shopify:</p>
            <img src="{{ section.settings.logo | img_url: 'master' }}" alt="Logo" style="max-width: 200px; max-height: 100px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">URL: {{ section.settings.logo | img_url: 'master' }}</p>
            <div data-shopify-logo-url="{{ section.settings.logo | img_url: 'master' }}" style="display: none;"></div>
          </div>
        {% endif %}
        <div 
          id="logo-dropzone" 
          style="border: 2px dashed #ddd; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; background: #f9f9f9; transition: all 0.3s;"
          onmouseover="this.style.borderColor='#ff0000'; this.style.background='#fff5f5';"
          onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9';"
        >
          <input 
            type="file" 
            id="logo-file" 
            accept="image/*" 
            style="display: none;"
          />
          <div id="logo-preview" style="display: none; margin-bottom: 15px;">
            <img id="logo-preview-img" src="" alt="Logo preview" style="max-width: 200px; max-height: 100px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <br>
            <button type="button" onclick="removeLogo()" style="margin-top: 10px; padding: 5px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
              ‚úï Eliminar
            </button>
          </div>
          <div id="logo-dropzone-text">
            <p style="margin: 0; color: #666; font-size: 16px;">üìé Arrastra y suelta tu logo aqu√≠</p>
            <p style="margin: 10px 0 0 0; color: #999; font-size: 14px;">o haz clic para seleccionar</p>
            <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">Formatos: JPG, PNG, SVG, WEBP (m√°x. 5MB)</p>
          </div>
        </div>
        <small style="display: block; margin-top: 8px; color: #666;">
          üí° El logo aparecer√° arriba en la p√°gina personalizada. Si subes una imagen, se usar√° esa. Si no, se usar√° el logo configurado en Shopify.
        </small>
      </div>
      
      <div style="margin-bottom: 30px;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 18px;">Prompt completo:</label>
        <textarea 
          id="custom-prompt" 
          name="prompt" 
          rows="12" 
          required
          style="width: 100%; padding: 16px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 15px; line-height: 1.6; resize: vertical;"
          placeholder="Escribe aqu√≠ todo el prompt con la informaci√≥n del cliente. Ejemplo:

Personaliza esta p√°gina para:
- Cliente: Juan P√©rez
- Empresa: Tech Solutions S.L.
- Objetivos: Aumentar ventas online en un 50%, mejorar experiencia de usuario
- Alcance: Desarrollo completo de e-commerce con integraci√≥n de pagos y gesti√≥n de inventario
- Timeline: 3 meses
- Equipo: 5 desarrolladores senior especializados en React y Node.js
- Precio: ‚Ç¨15,000

Destaca la innovaci√≥n tecnol√≥gica, escalabilidad y soporte post-entrega. El tono debe ser profesional pero cercano."
        ></textarea>
        <small style="display: block; margin-top: 8px; color: #666;">
          üí° Escribe toda la informaci√≥n del cliente y las instrucciones de personalizaci√≥n en un solo prompt
        </small>
      </div>
      
      <button 
        type="submit" 
        style="width: 100%; padding: 16px; background: #ff0000; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;"
        id="submit-btn"
      >
        Crear P√°gina Personalizada
      </button>
      
      <div id="result" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
    </form>
  </section>
  
  <script>
    let logoFile = null;
    let logoUrl = null;
    
    // Configurar dropzone
    const dropzone = document.getElementById('logo-dropzone');
    const fileInput = document.getElementById('logo-file');
    const preview = document.getElementById('logo-preview');
    const previewImg = document.getElementById('logo-preview-img');
    const dropzoneText = document.getElementById('logo-dropzone-text');
    
    // Click en dropzone
    dropzone.addEventListener('click', () => fileInput.click());
    
    // Cambio de archivo
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });
    
    // Arrastrar y soltar
    dropzone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropzone.style.borderColor = '#ff0000';
      dropzone.style.background = '#fff5f5';
    });
    
    dropzone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dropzone.style.borderColor = '#ddd';
      dropzone.style.background = '#f9f9f9';
    });
    
    dropzone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropzone.style.borderColor = '#ddd';
      dropzone.style.background = '#f9f9f9';
      
      if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
      }
    });
    
    // Manejar archivo seleccionado
    function handleFile(file) {
      // Validar tipo
      if (!file.type.startsWith('image/')) {
        alert('Por favor, selecciona una imagen v√°lida (JPG, PNG, SVG, WEBP)');
        return;
      }
      
      // Validar tama√±o (5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('La imagen es demasiado grande. M√°ximo 5MB');
        return;
      }
      
      logoFile = file;
      
      // Mostrar preview
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.style.display = 'block';
        dropzoneText.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
    
    // Eliminar logo
    function removeLogo() {
      logoFile = null;
      logoUrl = null;
      fileInput.value = '';
      preview.style.display = 'none';
      dropzoneText.style.display = 'block';
    }
    
    // Subir logo al servidor
    async function uploadLogo() {
      if (!logoFile) return null;
      
      const formData = new FormData();
      formData.append('logo', logoFile);
      
      try {
        // Extraer la base URL (sin /api/create-client si est√° presente)
        const apiUrl = '{{ section.settings.render_api_url | default: "https://reduncle-custom-lead.onrender.com/api/create-client" }}';
        const baseUrl = apiUrl.replace(/\/api\/create-client$/, '');
        const uploadUrl = baseUrl + '/api/upload-logo';
        
        console.log('üì§ Subiendo logo a:', uploadUrl);
        
        const response = await fetch(uploadUrl, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Error al subir el logo');
        }
        
        const data = await response.json();
        // Retornar tanto la URL como el filename para asociarlo al cliente
        return {
          url: data.url,
          filename: data.filename
        };
      } catch (error) {
        console.error('‚ùå Error al subir logo:', error);
        // Si falla, retornar null (no incluir logo en el prompt para evitar payload demasiado grande)
        alert('‚ö†Ô∏è No se pudo subir el logo. La p√°gina se crear√° sin logo.');
        return null;
      }
    }
    
    document.getElementById('create-client-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const resultDiv = document.getElementById('result');
      
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Generando p√°gina... (puede tardar 5-15 min)';
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#fff3cd';
      resultDiv.style.color = '#856404';
      resultDiv.style.border = '1px solid #ffc107';
      resultDiv.innerHTML = `
        <strong>‚è≥ Procesando...</strong><br>
        <small>El servidor est√° generando tu p√°gina personalizada. Esto puede tardar entre 5-15 minutos en el plan gratuito de Render (cold start + procesamiento de IA).</small><br>
        <small>üí° <strong>No cierres esta p√°gina.</strong> Revisa los logs de Render si quieres ver el progreso.</small>
      `;
      
       const prompt = document.getElementById('custom-prompt').value.trim();
       
       if (!prompt) {
         alert('Por favor, escribe un prompt con la informaci√≥n del cliente');
         submitBtn.disabled = false;
         submitBtn.textContent = 'Crear P√°gina Personalizada';
         return;
       }
       
       // Obtener logo: primero del archivo subido, luego de Shopify
       let logoUrl = null;
       if (logoFile) {
         submitBtn.textContent = '‚è≥ Subiendo logo...';
         try {
           const logoResult = await uploadLogo();
           if (logoResult && logoResult.url) {
             logoUrl = logoResult.url;
             console.log('‚úÖ Logo subido:', logoUrl);
           }
         } catch (error) {
           console.error('Error al subir logo:', error);
           // Continuar sin logo si falla
         }
       } else if (document.querySelector('[data-shopify-logo-url]')) {
         // Usar logo de Shopify si est√° disponible
         logoUrl = document.querySelector('[data-shopify-logo-url]').dataset.shopifyLogoUrl;
         console.log('‚úÖ Usando logo de Shopify:', logoUrl);
       }
       
       submitBtn.textContent = '‚è≥ Generando p√°gina... (puede tardar 1-3 min)';
       
       const formData = {
         prompt: prompt,
         logoUrl: logoUrl // Enviar la URL directamente
       };
       
      try {
        console.log('üöÄ Enviando request a:', '{{ section.settings.render_api_url | default: "https://reduncle-custom-lead.onrender.com/api/create-client" }}');
        
        // Crear un timeout de 20 minutos (1200 segundos) - Render free puede tardar mucho
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minutos
        
        const response = await fetch('{{ section.settings.render_api_url | default: "https://reduncle-custom-lead.onrender.com/api/create-client" }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('‚úÖ Response recibida:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Error del servidor:', errorText);
          throw new Error(`Error del servidor (${response.status}): ${errorText}`);
        }
        
        let data;
        try {
          const responseText = await response.text();
          console.log('üìÑ Response text recibido:', responseText.substring(0, 200));
          data = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('‚ùå Error al parsear JSON:', jsonError);
          throw new Error('Error al procesar la respuesta del servidor. La p√°gina puede haberse creado correctamente. Revisa los logs de Render.');
        }
        
        console.log('‚úÖ Datos recibidos:', data);
        
         if (data.success) {
           resultDiv.style.display = 'block';
           resultDiv.style.background = '#d4edda';
           resultDiv.style.color = '#155724';
           resultDiv.style.border = '1px solid #c3e6cb';
           resultDiv.innerHTML = `
             <strong>‚úÖ ¬°P√°gina creada exitosamente!</strong><br><br>
             <div style="margin: 15px 0;">
               <label style="display: block; margin-bottom: 8px; font-weight: 600;">üîó URL Personalizada:</label>
               <div style="display: flex; gap: 10px; align-items: center;">
                 <input 
                   type="text" 
                   id="client-url" 
                   value="${data.url}" 
                   readonly
                   style="flex: 1; padding: 12px; border: 2px solid #28a745; border-radius: 8px; background: white; font-size: 14px; font-family: monospace;"
                 />
                 <button 
                   type="button" 
                   onclick="copyUrl()" 
                   style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"
                 >
                   üìã Copiar
                 </button>
               </div>
               <small style="display: block; margin-top: 5px; color: #666;">Click en "Copiar" para copiar la URL al portapapeles</small>
             </div>
             <div style="margin-top: 15px;">
               <a href="${data.url}" target="_blank" style="color: #155724; text-decoration: underline; font-weight: 600;">
                 üëÅÔ∏è Ver p√°gina personalizada ‚Üí
               </a>
             </div>
           `;
         } else {
          throw new Error(data.error || 'Error desconocido');
        }
      } catch (error) {
        console.error('‚ùå Error completo:', error);
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.style.border = '1px solid #f5c6cb';
        
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
          errorMessage = '‚è±Ô∏è La solicitud tard√≥ demasiado (m√°s de 20 minutos). El servidor puede estar procesando. Revisa los logs de Render para ver si se cre√≥ el cliente.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage = 'üåê Error de conexi√≥n. El servidor puede estar iniciando (cold start ~50 segundos). Intenta de nuevo en unos segundos.';
        } else if (error.message.includes('JSON')) {
          errorMessage = '‚ö†Ô∏è Error al procesar la respuesta del servidor. La p√°gina puede haberse creado correctamente. Revisa los logs de Render.';
        }
        
        resultDiv.innerHTML = `
          <strong>‚ùå Error:</strong> ${errorMessage}<br><br>
          <small>üí° Tip: En el plan gratuito de Render, el servidor puede tardar ~50 segundos en iniciar si estaba inactivo.</small>
        `;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear P√°gina Personalizada';
      }
     });
     
     function copyUrl() {
       const urlInput = document.getElementById('client-url');
       if (urlInput) {
         urlInput.select();
         urlInput.setSelectionRange(0, 99999); // Para m√≥viles
         document.execCommand('copy');
         
         // Feedback visual
         const copyBtn = event.target;
         const originalText = copyBtn.textContent;
         copyBtn.textContent = '‚úÖ Copiado!';
         copyBtn.style.background = '#155724';
         
         setTimeout(() => {
           copyBtn.textContent = originalText;
           copyBtn.style.background = '#28a745';
         }, 2000);
       }
     }
   </script>
 {% else %}




{% endif %}

{% schema %}
{
  "name": "Crear Cliente Personalizado",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "T√≠tulo (privado)",
      "default": "Crear P√°gina Personalizada con IA"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo por defecto",
      "info": "Logo que se usar√° si no se sube uno espec√≠fico en el formulario"
    },
    {
      "type": "text",
      "id": "render_api_url",
      "label": "URL API de Render",
      "default": "https://reduncle-custom-lead.onrender.com/api/create-client",
      "info": "URL del endpoint para crear clientes"
    },
    {
      "type": "text",
      "id": "lock_title",
      "label": "T√≠tulo (bloqueado)",
      "default": "Acceso restringido"
    },
    {
      "type": "richtext",
      "id": "lock_text",
      "label": "Texto (bloqueado)",
      "default": "<p>Necesitas permisos de 'due√±o' para acceder a esta secci√≥n.</p>"
    },
    {
      "type": "text",
      "id": "login_label",
      "label": "Texto bot√≥n login",
      "default": "Iniciar sesi√≥n"
    }
  ],
  "presets": [
    {
      "name": "Crear Cliente Personalizado"
    }
  ]
}
{% endschema %}
